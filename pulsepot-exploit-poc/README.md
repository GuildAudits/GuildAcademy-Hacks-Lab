# PulsePot Flash Loan Exploit Simulation

## Overview

This Folder contains a Foundry-based proof-of-concept (PoC) to simulate a flash loan exploit that affected the PulsePot protocol's FortuneWheel smart contract on Binance Smart Chain (BSC) around January 10-11, 2025. The exploit resulted in a loss of approximately $21,528.20 by leveraging a vulnerability in the public `swapProfitFees()` function, which allowed an attacker to manipulate token swap prices in the LINK-WBNB PancakeSwap pair for arbitrage profit.

The PoC forks the BSC mainnet at block 45640245 (just before the exploit transaction) to replicate the chain state and simulate the attack path as closely as possible. This Folder is a simulation for test purpose , demonstrating how flash loan attacks exploit DeFi vulnerabilities and how to test for them using Foundry.

## Exploit Background

The PulsePot exploit targeted the FortuneWheel contract (address: `0x384B9fB6e42DAB87f3023D87Ea1575499A69998E`). The attacker:

1. Took a flash loan (approximately 4.3 BNB worth of LINK) from the PancakeSwap LINK-WBNB pair (`0x824EB9faDFB377394430d2744fa7c42916DE3eCE`).
2. Used the borrowed LINK to manipulate the pair's reserves, inflating the LINK price.
3. Called the vulnerable `swapProfitFees()` function, which executed a swap at the manipulated price, transferring value to the attacker.
4. Unwound the position by swapping back to repay the flash loan, pocketing \~$21.5k in profit.

The vulnerability stemmed from:

- `swapProfitFees()` being public, lacking access controls (e.g., `onlyOwner`).
- No slippage protection, price impact checks, or reentrancy guards.
- Susceptibility to price manipulation in a single transaction.

The exploit transaction is viewable on BSCScan: 0xd6ba15ecf3df9aaae37450df8f79233267af41535793ee1f69c565b50e28f7da.

## Simulation Objectives

The Foundry test (`test/Exploit.t.sol`) aims to:

- **Replicate the Attack Path**: Simulate the flash loan, price manipulation, vulnerable function call, and arbitrage profit.
- **Fork BSC Mainnet**: Use Foundry's `vm.createSelectFork` to recreate the chain state at block 45640245.
- **Validate the Exploit**: Confirm the attack yields a profit, mimicking the \~$21.5k gain.
- **Educate on Fixes**: Highlight vulnerabilities and suggest mitigations (e.g., access controls, slippage protection).

The test deploys an exploit contract that:

1. Initiates a flash swap from the LINK-WBNB pair.
2. Dumps borrowed LINK to manipulate the pool price.
3. Calls `swapProfitFees()` to exploit the victim's swap logic.
4. Swaps back to repay the loan and logs the profit.

## Prerequisites

- **Foundry**: Install via `curl -L https://foundry.paradigm.xyz | bash` and run `foundryup`.
- **Node.js**: For package management (optional).
- **BSC RPC Endpoint**: Use a public endpoint (e.g., `https://bsc-dataseed.binance.org/`) or a private one (e.g., Alchemy, Infura) for stability.

## Setup Instructions

1. **Clone the Repository**:

   ```
   git clone <repository-url>
   cd pulsepot-exploit-poc
   ```

2. **Install Dependencies**:

   ```
   forge install OpenZeppelin/openzeppelin-contracts --no-commit
   ```

   Ensure `remappings.txt` includes:

   ```
   @openzeppelin/contracts/=lib/openzeppelin-contracts/contracts/
   ```

3. **Verify Interfaces**: Check `src/interfaces/` for `IPancakePair.sol` and `IPancakeRouter02.sol`. These define minimal PancakeSwap interfaces for the LINK-WBNB pair and router.

4. **Build the Project**:

   ```
   forge build
   ```

## Running the Simulation

Run the test with verbose output to see the exploit steps:

```
forge test --match-test testExploit -vvv
```

- **Forking**: The test forks BSC at block 45640245 using `vm.createSelectFork`.
- **Output**: Logs the attacker's initial and final ETH balance to confirm profit.
- **Expected Result**: A positive profit, ideally close to the real exploit's \~$21.5k (4.3 BNB, depending on price feeds).

If the RPC endpoint is rate-limited, use a private node or adjust `borrowAmount` in `test/Exploit.t.sol` to match liquidity constraints.

## Key Components

- **test/Exploit.t.sol**:
  - Sets up the fork at block 45640245.
  - Deploys an exploit contract that borrows LINK, manipulates the pool, calls `swapProfitFees()`, and unwinds for profit.
  - Uses `pancakeCall` for the flash loan callback.
- **src/interfaces/**:
  - `IPancakePair.sol`: Defines the PancakeSwap pair interface for flash swaps.
  - `IPancakeRouter02.sol`: Defines the router for token swaps.
- **Addresses**:
  - FortuneWheel: `0x384B9fB6e42DAB87f3023D87Ea1575499A69998E`
  - LINK-WBNB Pair: `0x824EB9faDFB377394430d2744fa7c42916DE3eCE`
  - PancakeRouter: `0x10ED43C718714eb63d5aA57B78B54704E256024E`
  - WBNB: `0xBB4CdB9CBd36B01bD1cBaEBF2De08d9173bC095c`
  - LINK: `0xF8A0BF9cF54Bb92f17374d9e9A321E6a111a51bD`

## Post-Mortem and Mitigations

The exploit was analyzed by:

- **CertiK**: Flagged it as critical, recommending access controls and oracle price feeds.
- **Audita Security**: Suggested `onlyOwner` modifiers, slippage protection, reentrancy guards, and time locks.
- **SolidityScan**: Emphasized testing business logic and restricting public functions.

**Recommended Fixes**:

- Restrict `swapProfitFees()` with `onlyOwner` or role-based access (e.g., OpenZeppelin's `AccessControl`).
- Add slippage limits (e.g., `minAmountOut` in swaps).
- Use Chainlink oracles for price validation.
- Implement `ReentrancyGuard` to prevent recursive calls.
- Conduct pre-deployment audits with Slither/Mythril and test flash loan scenarios.

No public response from PulsePot (@JPulsepot) was found, suggesting internal handling. The community emphasized flash loan-resistant designs, such as TWAP oracles and circuit breakers, in broader DeFi discussions.

## Limitations

- **Liquidity**: The simulation may need tuning for `borrowAmount` to avoid pool depletion.
- **Token Order**: The LINK-WBNB pair's token order (WBNB/LINK or LINK/WBNB) may require adjusting `amount0Out`/`amount1Out`.
- **RPC Stability**: Public BSC nodes throttle; may need use of a private endpoint for reliability.

## Disclaimer

This Simulation only aims to demonstrate as closely the events that  likely happened and was for testing.